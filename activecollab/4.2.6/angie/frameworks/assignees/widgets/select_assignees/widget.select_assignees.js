jQuery.fn.selectAssignees=function(s){var settings=jQuery.extend({data:null,name:null,can_see_private:[],assignees:null,choose_responsible:false,responsible_name:null,responsible_user_id:0,choose_subscribers:false,subscribers_name:"subscribers",subscribers:null,small_form_visibility:false,supports_multiple_assignees:true},s);return this.each(function(){var wrapper=$(this).addClass("select_asignees").disableSelection();wrapper.append('<input type="hidden" class="no_other_assignees" value="" name="'+settings.name+'">');App.each(settings.data,function(company_name,company_users){var company_name_to_show=company_name.length>25?company_name.substr(0,25)+"...":company_name;var company_id=settings&&settings.companies_flipped&&settings.companies_flipped[company_name]?settings.companies_flipped[company_name]:"";var group='<div class="user_group" company_id="'+company_id+'"><label><input type="checkbox" name="" class="group_checkbox"> '+App.clean(company_name_to_show)+'</label><ul class="group_users">';App.each(company_users,function(user_id,user_name){var user_name_to_show=user_name.length>25?user_name.substr(0,25)+"...":user_name;group+='<li user_id="'+user_id+'" class="group_user" can_see_private="'+(jQuery.inArray(user_id.toString(),settings.can_see_private)==-1?0:1)+'"><span class="subscription_toggler"></span><input type="checkbox" name="'+settings.name+'[]" class="user_checkbox" value="'+user_id+'"> <span class="user_label">'+App.clean(user_name_to_show)+"</span></li>"});wrapper.append(group+"</ul></div>")});if(settings.add_people_url&&settings&&settings.companies_flipped){var add_people_url_link=$('<a href="'+settings.add_people_url+'" title="'+App.lang("Add People to Project")+'" class="link_button"><span class="inner"><span class="icon button_add">'+App.lang("Add People to Project")+"</span></span></a>").appendTo($('<div class="add_people_link"></div>').appendTo(wrapper));add_people_url_link.flyoutForm({width:640,success:function(result){if(!(result&&result.length)){return false}var user_list_element;var company_group;App.each(result,function(index,user){user_list_element=wrapper.find("li[user_id="+user.id+"]");if(user_list_element.length){return true}company_group=wrapper.find("div[company_id="+user.company_id+"]");if(!company_group||!company_group.length){company_group=$('<div class="user_group" company_id="'+user.company_id+'"><label><input type="checkbox" name="" class="group_checkbox"> '+App.clean(settings.companies[user.company_id])+'</label><ul class="group_users"></ul></div>').insertBefore(add_people_url_link.parent())}if(company_group.length){company_group.find("ul").append('<li user_id="'+user.id+'" class="group_user" can_see_private="'+(jQuery.inArray((user.id+""),settings.can_see_private)==-1?0:1)+'"><span class="subscription_toggler"></span><input type="checkbox" name="'+settings.name+'[]" class="user_checkbox" value="'+user.id+'"> <span class="user_label">'+App.clean(user.display_name)+"</span></li>")}});if(!settings.choose_subscribers){wrapper.find("span.subscription_toggler").remove()}},success_event:"new_people_on_project"})}if(settings.choose_responsible){wrapper.append('<input type="hidden" class="responsible_user_id" value="0" name="'+settings.responsible_name+'">')}if(!settings.choose_subscribers){wrapper.find("span.subscription_toggler").remove()}if(settings.choose_responsible){var responsible_user_input=wrapper.find("input.responsible_user_id")}var set_as_responsible=function(user){if(user.find("input.user_checkbox:checked").length<1){user.find("input.user_checkbox").prop("checked",true)}subscribe_user(user);responsible_user_input.val(user.attr("user_id"));wrapper.find("li.group_user").removeClass("responsible");user.addClass("responsible");if(!settings.supports_multiple_assignees){wrapper.find("li").not(".responsible").find("input.user_checkbox").prop("checked",false)}update_group_checkbox(user.parents("div.user_group"))};var update_responsible=function(){var first_user_checkbox=wrapper.find("input.user_checkbox:checked:first");if(first_user_checkbox.length>0){var responsible_user_id=parseInt(responsible_user_input.val());if(responsible_user_id>0){var responsible_user=wrapper.find("li.group_user[user_id="+responsible_user_id+"]");if(responsible_user.find("input:checked").length<1){set_as_responsible(first_user_checkbox.parent())}}else{set_as_responsible(first_user_checkbox.parent())}}else{responsible_user_input.val(0);wrapper.find("li.group_user").removeClass("responsible")}};var select_user=function(user,bulk){if(user.find("input.user_checkbox:checked").length<1){user.find("input.user_checkbox").prop("checked",true)}subscribe_user(user);if(!bulk){update_responsible()}};var deselect_user=function(user,bulk){if(user.find("input.user_checkbox:checked").length==1){user.find("input.user_checkbox").prop("checked",false)}unsubscribe_user(user);if(!bulk){update_responsible()}};var subscribe_user=function(user){if(!user.hasClass("subscribed")){user.addClass("subscribed")}if(wrapper.find("input.user_subscription[value="+user.attr("user_id")+"]").length<1){wrapper.append('<input type="hidden" name="'+settings.subscribers_name+'[]" value="'+user.attr("user_id")+'" class="user_subscription">')}};var unsubscribe_user=function(user){if(user.find("input.user_checkbox").is(":checked")){return false}user.removeClass("subscribed");var subscriber=wrapper.find("input.user_subscription[value="+user.attr("user_id")+"]");if(subscriber.length>0){subscriber.remove()}};var update_group_checkbox=function(group){if(!settings.supports_multiple_assignees){group.find("input.group_checkbox").remove();return true}if(group.find("input.user_checkbox").length==group.find("input.user_checkbox:checked").length){group.find("input.group_checkbox").prop("checked",true)}else{group.find("input.group_checkbox").prop("checked",false)}};wrapper.on("click","input.group_checkbox",function(){var group=$(this).parents("div.user_group:first");var group_selected=this.checked;group.find("li.group_user").each(function(){if(group_selected){select_user($(this),true)}else{deselect_user($(this),true)}});update_responsible()});wrapper.on("click","input.user_checkbox",function(){var user=$(this).parents("li.group_user:first");var group=user.parents("div.user_group:first");if(this.checked){if(!settings.supports_multiple_assignees){set_as_responsible(user)}else{select_user(user,false)}}else{deselect_user(user,false)}update_group_checkbox(group)});wrapper.on("click","span.user_label",function(){var user=$(this).parents("li.group_user:first");var group=user.parents("div.user_group:first");select_user(user,true);set_as_responsible(user);update_group_checkbox(group)});wrapper.on("click","span.subscription_toggler",function(){var user=$(this).parents("li.group_user:first");if(user.is(".subscribed")){unsubscribe_user(user)}else{subscribe_user(user)}});if(settings.choose_responsible&&settings.responsible_user_id){var responsible_user=wrapper.find("li.group_user[user_id="+settings.responsible_user_id+"]");if(responsible_user.length==1){set_as_responsible(responsible_user)}}if(typeof(settings.assignees)&&settings.assignees){App.each(settings.assignees,function(k,assignee_id){var assignee=wrapper.find("li.group_user[user_id="+assignee_id+"]");if(assignee.length==1){select_user(assignee,true)}})}if(settings.choose_subscribers&&typeof(settings.subscribers)=="object"&&settings.subscribers){App.each(settings.subscribers,function(k,subscriber_id){var subscriber=wrapper.find("li.group_user[user_id="+subscriber_id+"]");if(subscriber.length==1){subscribe_user(subscriber)}})}wrapper.find("div.user_group").each(function(){update_group_checkbox($(this))});var filter_by_visibility=function(visibility){var wrapper=$(this);wrapper.find("div.user_group").each(function(){var group=$(this);group.show();if(visibility==1){group.find("li").show()}else{group.find('li[can_see_private="0"]').hide();group.find('li[can_see_private="1"]').show()}if(group.find("li:visible").length){group.show()}else{group.hide()}});wrapper.find('input[type="checkbox"]:not(:visible):checked').each(function(){var checkbox=$(this);checkbox.prop("checked",false);unsubscribe_user(checkbox.parents("li:first"))});var responsible_hidden=wrapper.find("li.responsible:hidden");if(responsible_hidden.length){responsible_hidden.removeClass("responsible");update_responsible()}};this.filterByVisibility=filter_by_visibility;if(settings.small_form_visibility!==false){this.filterByVisibility(settings.small_form_visibility)}})};