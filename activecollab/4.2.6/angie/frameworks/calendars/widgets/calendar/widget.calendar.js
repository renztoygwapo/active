(function($){var public_methods={init:function(options){return this.each(function(){try{var widget=new Widget();widget.init(this,options)}catch(err){console.log(err)}})}};var calculate_spanned_event_colors=function(initial_color,same_background,lighten_text){var lightened_background_color=initial_color;if(!same_background){lightened_background_color=tinycolor(initial_color).toHsl();lightened_background_color.s=0.5;lightened_background_color.l=0.93;lightened_background_color=tinycolor(lightened_background_color).toHexString()}if(lighten_text){var text_color=tinycolor.lighten(initial_color,40)}else{var text_color=tinycolor.darken(initial_color,40)}return{"background-color":lightened_background_color,"text-color":text_color.toHexString(),"border-color":initial_color}};var Calendar=function(widget,data){var _this=this;this.id=typeof data.id!="undefined"?data.id:0;this.name=typeof data.name!="undefined"?data.name:"";this.color=typeof data.color!="undefined"?data.color:"FF0000";this.type=typeof data.type!="undefined"?data.type:"";this.visible=typeof data.visible!="undefined"?parseInt(data.visible):1;this.created_by_id=typeof data.created_by_id!="undefined"?parseInt(data.created_by_id):0;this.created_by_name=typeof data.created_by_name!="undefined"?data.created_by_name:null;this.permissions={can_edit:typeof data.permissions!="undefined"&&typeof data.permissions.can_edit!="undefined"?data.permissions.can_edit:false,can_trash:typeof data.permissions!="undefined"&&typeof data.permissions.can_trash!="undefined"?data.permissions.can_trash:false};this.urls={edit:typeof data.urls!="undefined"&&typeof data.urls.edit!="undefined"?data.urls.edit:"#",trash:typeof data.urls!="undefined"&&typeof data.urls.trash!="undefined"?data.urls.trash:"#",change_visibility:typeof data.urls!="undefined"&&typeof data.urls.change_visibility!="undefined"?data.urls.change_visibility:"#",ical:typeof data.urls!="undefined"&&typeof data.urls.ical!="undefined"?data.urls.ical:"#"};this.post_fields=new Array("id","name","color","visible");this.prepare=function(fields){var calendar=this;if(typeof fields=="undefined"){fields=_this.post_fields}var result={};$.each(fields,function(index,value){result[value]=calendar[value]});return result};this.render=function(as_object){if(typeof as_object=="undefined"){as_object=false}var default_dolor="464646";var calendar=this;var active=calendar.visible?"active":"";var color="#"+(calendar.color?calendar.color:default_dolor);var rendered="";rendered+='<li class="calendar" data-type="'+calendar.type+'" data-id="'+calendar.id+'" data-visible="'+(active?1:0)+'">';rendered+='<span class="swatch">';rendered+='<span class="color" style="background-color: '+color+'"></span>';rendered+='<a href="#" class="status '+active+'"></a>';rendered+="</span>";rendered+='<span class="calendar_name">'+App.clean(calendar.name)+"</span>";if(calendar.permissions.can_edit||calendar.permissions.can_trash||widget.data.is_feed_user){rendered+='<span class="controls">';if(widget.data.is_feed_user){rendered+='<a href="'+calendar.urls.ical+'" title="'+App.lang("iCalendar Feed")+'" class="ical"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/icalendar.png","environment")+'" /></a>'}if(calendar.permissions.can_edit){rendered+='<a href="'+calendar.urls.edit+'" title="'+App.lang("Edit")+'" class="edit"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/edit.png","environment")+'" /></a>'}if(calendar.permissions.can_trash){rendered+='<a href="'+calendar.urls.trash+'" title="'+App.lang("Trash")+'" class="remove"><img src="'+App.Wireframe.Utils.imageUrl("icons/12x12/move-to-trash.png","system")+'" /></a>'}rendered+="</span>"}rendered+="</li>";return as_object?$(rendered):rendered};this.setVisible=function(widget,value,skip_save){var calendar=this;calendar.visible=value?1:0;widget.calendars.update(calendar);var rendered_calendar=calendar.render(true);rendered_calendar.attr("data-visible",calendar.visible);if(widget.selected_calendar instanceof Calendar&&widget.selected_calendar.type==calendar.type&&widget.selected_calendar.id==calendar.id){rendered_calendar.addClass("selected")}widget.wireframe.sidebar_content.find('li.calendar[data-id="'+calendar.id+'"][data-type="'+calendar.type+'"]').replaceWith(rendered_calendar);if(!skip_save){$.ajax({url:calendar.urls.change_visibility,type:"POST",data:{submitted:"submitted",visible:calendar.visible}});RefreshMainCheckbox(rendered_calendar.parents(".calendar_sidebar_group:first"))}};this.isVisible=function(){return this.visible?true:false};this.isMy=function(user_id){return this.created_by_id==user_id}};var Calendars=function(widget){var _this=this;this.data=new Array();this.get=function(type,id){id=parseInt(id);if(id>0){var result=false;$.each(_this.data,function(index,calendar){if(calendar.id==id&&calendar.type==type){result=calendar;return false}});return result}else{return _this.data}};this.getByCalendarEvent=function(calendar_event){if(calendar_event instanceof CalendarEvent){var result=false;$.each(_this.data,function(index,calendar){if(calendar.type==calendar_event.parent_type&&calendar.id==calendar_event.parent_id){result=calendar;return false}});return result}else{throw new InvalidInstanceError("Object is not instance of CalendarEvent")}};this.getByTypeAndId=function(type,id){var result=false;$.each(_this.data,function(index,calendar){if(calendar.type==type&&calendar.id==id){result=calendar;return false}});return result};this.add=function(calendar){if(calendar instanceof Calendar){_this.data.push(calendar)}};this.update=function(calendar){if(calendar instanceof Calendar){$.each(_this.data,function(index,looped_calendar){if(looped_calendar.id==calendar.id&&looped_calendar.type==calendar.type){_this.data[index]=calendar;return false}})}};this.unset=function(calendar){if(calendar instanceof Calendar){var calendar_pool=new Array();$.each(_this.data,function(index,looped_calendar){if(looped_calendar.type==calendar.type&&looped_calendar.id==calendar.id){return true}calendar_pool.push(looped_calendar)});_this.data=calendar_pool}else{throw new InvalidInstanceError(App.lang("Object is not instance of Calendar"))}};this.unsetAll=function(){_this.data=new Array()};this.render=function(calendars){if(!(calendars instanceof Array)){calendars=new Array(calendars)}var rendered="";$.each(calendars,function(index,calendar){if(calendar instanceof Calendar){rendered+=calendar.render()}});return $(rendered)}};var RefreshMainCheckbox=function(group){var group_checkbox=group.find("span.group_checkbox a");if(group.find("div.calendars_wrapper li.calendar a.status").length==group.find("div.calendars_wrapper li.calendar a.status.active").length){group_checkbox.addClass("active")}else{group_checkbox.removeClass("active")}};var Group=function(widget,data){var _this=this;this.name=typeof data.name!="undefined"?data.name:"";this.label=typeof data.label!="undefined"?data.label:App.lang("Undefined");this.calendars=typeof data.calendars!="undefined"?data.calendars:new Array();this.options=typeof data.options!="undefined"?data.options:null;this.can_add=!!(_this.name=="default");this.render=function(content){var group=this;var rendered="";var option=false;rendered+='<div class="calendar_sidebar_group">';rendered+='<span class="group_checkbox"><span class="color"></span><a class="status" href="#"></a></span>';rendered+="<h3>"+App.clean(group.label)+"</h3>";if(group.options!=null){rendered+='<div class="calendar_group_options">';rendered+='<span class="options_button">'+App.lang("Options")+"</span>";rendered+='<div class="options_drop_down">';rendered+='<ul class="options_list"></ul>';rendered+="</div>";rendered+="</div>"}rendered+='<div class="calendars_wrapper" data-type="'+group.name+'">'+content+"</div>";rendered+="</div>";var group_jquery=$(rendered);if(group.options&&group.options["new"]){var option=group.options["new"];var anchor=$('<a href="'+option.url+'" id="new_option">'+App.lang("Add")+"</a>").insertAfter(group_jquery.find("h3:first"));var onclick_handler;if(option.onclick&&typeof(option.onclick)=="string"){eval("onclick_handler = "+option.onclick)}else{if(option.onclick&&typeof(option.onclick)=="function"){onclick_handler=option.onclick}}if(onclick_handler){onclick_handler.apply(anchor[0])}}if(group.options!=null){$.each(group.options,function(index,option){var object=$('<li><a href="'+option.url+'">'+option.label+"</a></li>");if(typeof(option.onclick)=="string"&&option.onclick){var onclick;eval("onclick = "+option.onclick);if(typeof(onclick)=="function"){onclick.apply(object.find("a"))}}object.appendTo(group_jquery.find("ul.options_list"))})}RefreshMainCheckbox(group_jquery);return group_jquery}};var Groups=function(widget){var _this=this;this.data=new Array();var Map=function(title){this.calendars=new Array();this.title=title};this.init=function(){$.each(widget.data.groups,function(name,data){data.name=name;var group=new Group(widget,data);_this.data.push(group)});var rendered_groups="";var groups=_this.get();$.each(groups,function(index,group){var maps=new Object();var user_order=new Array();var rendered_calendars="";if(group.calendars.length>0){$.each(group.calendars,function(index,data){var calendar=new Calendar(widget,data);widget.calendars.add(calendar);var created_by_id=calendar.created_by_id;var created_by_name=calendar.created_by_name;if(!(maps[created_by_id] instanceof Map)){maps[created_by_id]=new Map(created_by_name);user_order.push(created_by_id)}if(maps[created_by_id]["calendars"] instanceof Array){maps[created_by_id]["calendars"].push(calendar)}});$.each(user_order,function(index,user_id){var calendars=maps[user_id]["calendars"];var content="";$.each(calendars,function(index,calendar){content+=calendar.render()});var title=maps[user_id]["title"];rendered_calendars+=_this.wrapCalendars(user_id,title,content)})}else{rendered_calendars=_this.renderEmptyList()}var rendered_group=group.render(rendered_calendars);rendered_group.appendTo(widget.wireframe.sidebar_content)})};this.get=function(name){if(typeof name!="undefined"&&name){var group=false;$.each(_this.data,function(){if(this.name==name){group=this;return false}});return group}else{return _this.data}};this.add=function(group){if(group instanceof Group){_this.data.push(group)}};this.update=function(group){if(group instanceof Group){$.each(_this.data,function(index,group_to_update){if(group_to_update.name==group.name){_this.data[index]=group;return false}});App.Wireframe.Flash.success(App.lang("Calendar has been updated"))}};this.wrapCalendars=function(user_id,title,content,as_object){var render="";user_id=parseInt(user_id);if((user_id>0&&user_id!=widget.data.settings.logged_user.id)){render+='<div class="user_calendar_name"><span>'+title+"</span></div>"}render+='<ul data-user-id="'+user_id+'">';render+=typeof content!="undefined"?content:"&nbsp;";render+="</ul>";return as_object?$(render):render};this.renderEmptyList=function(as_object){var render="";render+='<p class="empty_page">'+App.lang("Empty list")+"</p>";return as_object?$(render):render};this.render=function(groups){if(!(groups instanceof Array)){groups=new Array(groups)}$.each(groups,function(index,group){if(group instanceof Group){var render="";render+='<div class="calendar_sidebar_group">';render+="<h3>"+App.clean(group.label)+"</h3>";if(group.can_add){render+='<a href="'+widget.data.urls.calendars_add+'" class="add_new_calendar">+ '+App.lang("Add new calendar")+"</a>"}render+='<div class="calendars_wrapper" data-type="'+group.name+'"></div>';render+="</div>";$(render).appendTo(widget.wireframe.sidebar_content)}})}};var CalendarEvent=function(widget,data){var _this=this;var default_fields={id:"id",name:"name",starts_on:"starts_on",ends_on:"ends_on",repeat_until:"repeat_until"};var date_vars=new Array("starts_on","ends_on","temp_starts_on","temp_ends_on","repeat_until");this.id=typeof data.id!="undefined"?parseInt(data.id):0;this.type=typeof data.type!="undefined"?data.type:"";this.parent_id=typeof data.parent_id!="undefined"?parseInt(data.parent_id):0;this.parent_type=typeof data.parent_type!="undefined"?data.parent_type:"";this.name=typeof data.name!="undefined"?data.name:"";this.org_parent_id=typeof data.org_parent_id!="undefined"?data.org_parent_id:null;this.org_parent_type=typeof data.org_parent_type!="undefined"?data.org_parent_type:null;var _starts_on=typeof data.starts_on!="undefined"?new Date(Date.parse(data.starts_on["mysql"])):null;this.starts_on=_starts_on instanceof Date?new Date(_starts_on.getTime()+(_starts_on.getTimezoneOffset()*60000)):null;var _ends_on=typeof data.ends_on!="undefined"?new Date(Date.parse(data.ends_on["mysql"])):_this.starts_on;this.ends_on=_ends_on instanceof Date?new Date(_ends_on.getTime()+(_ends_on.getTimezoneOffset()*60000)):null;this.temp_starts_on=_this.starts_on instanceof Date?_this.starts_on.clone():null;this.temp_ends_on=_this.ends_on instanceof Date?_this.ends_on.clone():null;this.new_start_date=null;this.dragging=false;this.repeat=typeof data.repeat!="undefined"?data.repeat:"dont";this.repeat_id=typeof data.repeat_id!="undefined"?data.repeat_id:0;var _repeat_until=data.repeat_until?new Date(Date.parse(data.repeat_until["mysql"])):null;this.repeat_until=_repeat_until instanceof Date?new Date(_repeat_until.getTime()+(_repeat_until.getTimezoneOffset()*60000)):null;this.temp_repeat_until=_this.repeat_until instanceof Date?_this.repeat_until.clone():null;this.starts_on_time=data.starts_on_time;this.permissions={can_edit:typeof data.permissions!="undefined"&&typeof data.permissions.can_edit!="undefined"?data.permissions.can_edit:false,can_trash:typeof data.permissions!="undefined"&&typeof data.permissions.can_trash!="undefined"?data.permissions.can_trash:false,can_reschedule:typeof data.permissions!="undefined"&&typeof data.permissions.can_reschedule!="undefined"?data.permissions.can_reschedule:false};this.urls={view:typeof data.urls!="undefined"&&typeof data.urls.view!="undefined"?data.urls.view:false,edit:typeof data.urls!="undefined"&&typeof data.urls.edit!="undefined"?data.urls.edit:false,trash:typeof data.urls!="undefined"&&typeof data.urls.trash!="undefined"?data.urls.trash:false,reschedule:typeof data.urls!="undefined"&&typeof data.urls.reschedule!="undefined"?data.urls.reschedule:false};this.completed=typeof data.completed!="undefined"?data.completed:false;this.archived=typeof data.archived!="undefined"?data.archived:false;this.render=true;this.prepare=function(fields){var calendar_event=this;var result={};if(typeof fields=="undefined"||!(fields instanceof Object)){fields=default_fields}if(calendar_event instanceof CalendarEvent){$.each(fields,function(index,value){if(typeof(calendar_event[value])=="undefined"||!calendar_event[value]){return true}if($.inArray(value,date_vars)>-1&&calendar_event[value] instanceof Date){result[index]=calendar_event[value].toString("yyyy-MM-dd")}else{result[index]=calendar_event[value]}})}return result};this.cancelDragging=function(widget){var calendar_event=this;calendar_event.temp_starts_on=calendar_event.starts_on;calendar_event.temp_ends_on=calendar_event.ends_on;calendar_event.new_start_date=null;calendar_event.dragging=false;widget.calendar_events.update(calendar_event)};this.clone=function(){var calendar_event=this;var calendar_event_clone=new CalendarEvent(widget,this);calendar_event_clone.starts_on=calendar_event.starts_on.clone();calendar_event_clone.ends_on=calendar_event.ends_on.clone();calendar_event_clone.temp_starts_on=calendar_event.starts_on.clone();calendar_event_clone.temp_ends_on=calendar_event.ends_on.clone();if(calendar_event_clone.repeat_until){calendar_event_clone.repeat_until=calendar_event.repeat_until.clone()}return calendar_event_clone};this.isRepeating=function(){return !!(_this.repeat!="dont")}};var CalendarEvents=function(widget){var _this=this;this.data=new Array();this.init=function(){if(widget.data.events.length){$.each(widget.data.events,function(index,data){var calendar_event=new CalendarEvent(widget,data);_this.data.push(calendar_event)})}};this.get=function(type,id){id=parseInt(id);if(id>0){var calendar_event=false;$.each(_this.data,function(index,looped_calendar_event){if(looped_calendar_event.id==id&&looped_calendar_event.type==type){calendar_event=looped_calendar_event;return false}});return calendar_event}else{return _this.data}};this.getByCalendar=function(calendar){var calendar_events_pool=new Array();if(calendar instanceof Calendar){$.each(_this.data,function(index,calendar_event){if(calendar_event.parent_id==calendar.id&&calendar_event.parent_type==calendar.type){calendar_events_pool.push(calendar_event)}})}return calendar_events_pool};this.add=function(calendar_event){if(calendar_event instanceof CalendarEvent){_this.data.push(calendar_event)}else{throw new InvalidInstanceError("Object is not instance of CalendarEvent")}};this.update=function(calendar_event,save,fields){if(typeof save=="undefined"){save=false}if(calendar_event instanceof CalendarEvent){$.each(_this.data,function(index,looped_calendar_event){if(looped_calendar_event.id==calendar_event.id&&looped_calendar_event.type==calendar_event.type){_this.data[index]=calendar_event;return false}});if(save&&calendar_event.permissions.can_edit){$.ajax({url:calendar_event.urls.edit,type:"POST",data:{submitted:"submitted",calendar_event:calendar_event.prepare(fields)},success:function(){App.Wireframe.Flash.success(App.lang("Calendar event has been updated"))}})}}};this.exsist=function(calendar_event){if(!(calendar_event instanceof CalendarEvent)){return false}var found=false;$.each(_this.data,function(index,looped_calendar_event){if(looped_calendar_event.id==calendar_event.id&&looped_calendar_event.type==calendar_event.type){found=true;return false}});return found};this.unset=function(calendar_event){if(calendar_event instanceof CalendarEvent){var calendar_events_pool=new Array();$.each(_this.data,function(index,looped_calendar_event){if(looped_calendar_event.type==calendar_event.type&&looped_calendar_event.id==calendar_event.id){return true}calendar_events_pool.push(looped_calendar_event)});_this.data=calendar_events_pool}else{throw new InvalidInstanceError(App.lang("Object is not instance of CalendarEvent"))}};this.changeRenderByParent=function(parent,render){if(typeof(render)=="undefined"){render=false}if(parent instanceof CalendarEvent){var calendar_events_pool=new Array();$.each(_this.data,function(index,looped_calendar_event){if(looped_calendar_event.org_parent_type==parent.type&&looped_calendar_event.org_parent_id==parent.id){_this.data[index]["render"]=render}})}else{throw new InvalidInstanceError(App.lang("Object is not instance of CalendarEvent"))}};this.unsetByCalendar=function(calendar){if(calendar instanceof Calendar){var calendar_events_pool=new Array();$.each(_this.data,function(index,looped_calendar_event){if(looped_calendar_event.parent_type==calendar.type&&looped_calendar_event.parent_id==calendar.id){return true}calendar_events_pool.push(looped_calendar_event)});_this.data=calendar_events_pool}else{throw new InvalidInstanceError(App.lang("Object is not instance of Calendar"))}};this.unsetAll=function(){_this.data=new Array()};this.fetch=function(date){var history_url=widget.url.prepare(widget.data.urls.data,date,true);var url=history_url;if(widget.data.filter.enabled){url=widget.filter.getUrl()}url=App.extendUrl(url,{async:1});_this.xhr=$.ajax({url:url,success:function(response){$.each(response,function(index,data){var calendar_event=new CalendarEvent(widget,data);if(_this.exsist(calendar_event)){_this.update(calendar_event)}else{_this.data.push(calendar_event)}});History.pushState({skip:true},App.lang("Loading..."),history_url)}});return _this.xhr};this.cancelFetch=function(){if(typeof _this.xhr!="undefined"){_this.xhr.abort()}}};var Filter=function(widget){var _this=this;this.init=function(){var options=widget.data.filter.options;var users=widget.data.filter.users;var selected_option=widget.data.filter.selected_option;var render="";render+='<div class="calendar_user_filter">';render+='<label for="filter_selector">'+App.lang("Filter")+":</label>";render+='<select id="filter_selector" class="filter_selector">';if($.isPlainObject(options)&&!$.isEmptyObject(options)){$.each(options,function(type,name){var selected=selected_option==type?'selected="selected"':"";render+='<option value="'+type+'" '+selected+">"+name+"</option>"})}if($.isPlainObject(users)&&!$.isEmptyObject(users)){$.each(users,function(group_name,group_users){if($.isPlainObject(group_users)&&!$.isEmptyObject(group_users)){render+='<optgroup label="'+group_name+'">';$.each(group_users,function(looped_user_id,name){var selected=selected_option==looped_user_id?'selected="selected"':"";render+='<option value="'+looped_user_id+'" data-type="user" '+selected+">"+name+"</option>"});render+="</optgroup>"}})}render+="</select>";render+="</div>";widget.wireframe.sidebar.find("div.calendar_sidebar_group").first().after($(render));widget.wireframe.sidebar.on("change","select.filter_selector",function(event){var filter_selector=$(this);var url=_this.getUrl(filter_selector);App.Wireframe.Content.setFromUrl(url)})};this.getUrl=function(filter_selector){if(typeof filter_selector=="undefined"){var filter_selector=widget.wireframe.sidebar.find("select.filter_selector")}var value=filter_selector.val();var data_type=filter_selector.find("option:selected").attr("data-type");var is_user=data_type=="user";var url=widget.url.get();if(is_user){url=App.extendUrl(url,{filter:"user",id:value})}else{url=App.extendUrl(url,{filter:value})}return url};this.apply=function(user){}};var UnknownObjectError=function(message){this.message=message?message:App.lang("Unknown object");this.name="UnknownObjectError"};var InvalidInstanceError=function(message){this.message=message;this.name="InvalidInstanceError"};var InvalidDateObjectError=function(message){this.message=message?message:App.lang("Value need to be valid date object");this.name="InvalidDateObjectError"};var Wireframe=function(widget){var _this=this;this.init=function(){$(widget.wrapper).addClass("calendar_widget").empty();_this.sidebar=$('<div class="sidebar"></div>').appendTo(widget.wrapper).append('<div class="sidebar_title">'+App.lang("Calendars")+'<a href="" class="hide_sidebar"></a></div>');_this.sidebar_content=$('<div class="sidebar_content"></div>').appendTo(_this.sidebar);_this.main=$('<div class="main-area"></div>').appendTo(widget.wrapper);_this.top=$('<div class="cal-nav"></div>').appendTo(_this.main);_this.bottom=$('<div class="cal-body"></div>').appendTo(_this.main);var show_calendar=function(list_element,skip_saving){var id=list_element.attr("data-id");var type=list_element.attr("data-type");var calendar=widget.calendars.get(type,id);list_element.find("a").addClass("active");if(calendar instanceof Calendar){calendar.setVisible(widget,true,skip_saving);RefreshMainCheckbox(list_element.parents(".calendar_sidebar_group:first"));if(!skip_saving){RefreshMainCheckbox(list_element.parents(".calendar_sidebar_group:first"))}}};var hide_calendar=function(list_element,skip_saving){var id=list_element.attr("data-id");var type=list_element.attr("data-type");var calendar=widget.calendars.get(type,id);list_element.find("a").removeClass("active");if(calendar instanceof Calendar){calendar.setVisible(widget,false,skip_saving);if(!skip_saving){RefreshMainCheckbox(list_element.parents(".calendar_sidebar_group:first"))}}};$(widget.wrapper).on("click","li.calendar a.status",function(dom_event){var target=$(dom_event.target);var list_element=target.parents("li:first");if(target.is(".active")){hide_calendar(list_element)}else{show_calendar(list_element)}widget.grid.renderCalendarEvents();return false});$(widget.wrapper).on("mouseenter","div.calendar_sidebar_group ul li",function(){$(this).addClass("over")}).on("mouseleave","div.calendar_sidebar_group ul li",function(){$(this).removeClass("over")}).on("click","div.calendar_sidebar_group ul li a.ical",function(dom_event){var object=$(this);App.Delegates.flyoutFormClick.apply(this,[dom_event,{width:500,title:App.lang("iCalendar Feed"),href:object.attr("href")}]);return false}).on("click","div.calendar_sidebar_group ul li a.edit",function(dom_event){var object=$(this);App.Delegates.flyoutFormClick.apply(this,[dom_event,{width:"350",title:App.lang("Edit Calendar"),href:object.attr("href"),success_event:"calendar_updated"}]);return false}).on("click","div.calendar_sidebar_group ul li a.remove",function(){var object=$(this);var id=object.parents("li.calendar:first").attr("data-id");var type=object.parents("li.calendar:first").attr("data-type");var calendar=widget.calendars.get(type,id);if(confirm(App.lang("Are you sure you want move this calendar to trash?"))){$.ajax({url:object.attr("href"),type:"POST",data:""});App.Wireframe.Events.trigger("calendar_deleted",calendar)}return false}).on("mouseover","span.options_button",function(){$(this).parent().addClass("opened")}).on("mouseenter","span.options_button",function(){$(this).parent().addClass("opened")}).on("mouseleave","span.options_button",function(){$(this).parent().removeClass("opened")}).on("mouseover","div.options_drop_down",function(){$(this).parent().addClass("opened")}).on("mouseleave","div.options_drop_down",function(){$(this).parent().removeClass("opened")});$(widget.wrapper).on("click","span.group_checkbox a",function(){var anchor=$(this).toggleClass("active");var child_calendars=anchor.parents("div.calendar_sidebar_group").find('div.calendars_wrapper li.calendar[data-visible="'+(anchor.is(".active")?0:1)+'"]');if(!child_calendars.length){return false}var calendars=[];var type=child_calendars.eq(0).attr("data-type");$.each(child_calendars,function(index,child_calendar){var $child_calendar=$(child_calendar);if(anchor.is(".active")){show_calendar($child_calendar,true)}else{hide_calendar($child_calendar,true)}calendars.push({id:$child_calendar.attr("data-id"),type:type})});$.ajax({url:widget.data.urls.mass_visibility,type:"POST",data:{calendars:calendars,visible:anchor.is(".active")?1:0,submitted:"submitted"}});widget.grid.renderCalendarEvents();return false});$(widget.wrapper).on("click","li.calendar",function(){var object=$(this);var id=object.attr("data-id");var type=object.attr("data-type");var prev_selected_state=object.hasClass("selected");_this.sidebar.find("li.calendar.selected").removeClass("selected");var selected_calendar_event=widget.selected_calendar_event;if(selected_calendar_event instanceof CalendarEvent&&(id!=selected_calendar_event.parent_id||type!=selected_calendar_event.parent_type||prev_selected_state)){var starts_on=selected_calendar_event.starts_on;var ends_on=selected_calendar_event.ends_on;var prev_objects=_this.bottom.find('div.event[data-id="'+selected_calendar_event.id+'"][data-type="'+selected_calendar_event.type+'"][data-from="'+selected_calendar_event.parent_type+'"][data-from-id="'+selected_calendar_event.parent_id+'"]');var prev_calendar=widget.calendars.get(selected_calendar_event.parent_type,selected_calendar_event.parent_id);$.each(prev_objects,function(){var prev_object=$(this);if(starts_on<ends_on){var calculated_colors=calculate_spanned_event_colors("#"+prev_calendar.color);prev_object.find("span.color").css({"background-color":calculated_colors["border-color"]});prev_object.removeClass("selected").css("background-color",calculated_colors["background-color"]).css("color",calculated_colors["text-color"]).css("border","1px solid "+calculated_colors["border-color"])}else{prev_object.css("background-color","transparent")}});widget.selected_calendar_event=null}widget.selected_calendar=null;if(!prev_selected_state){widget.selected_calendar=widget.calendars.get(type,id);object.addClass("selected")}});_this.sidebar.on("click",".calendar a.edit",function(event){var action=$(this);var calendar=action.parents(".calendar:first");var url=action.attr("href");var type=calendar.attr("data-type");var title=App.lang("Calendar Edit");if(type=="Project"){title=App.lang("Change Color")}$(this).bubble({url:url,pointTo:calendar.find(".calendar_name"),width:350,onSuccess:"calendar_updated",title:title});App.Wireframe.Events.bind("user_calendar_deleted",function(event,response){action.bubble("close")});return false});var toggle_sidebar=function(visible,save){if(visible){_this.sidebar.show();widget.wrapper.removeClass("sidebar_hidden");$("#wireframe_page_title").removeClass("calendar_sidebar_hidden")}else{_this.sidebar.hide();widget.wrapper.addClass("sidebar_hidden");$("#wireframe_page_title").addClass("calendar_sidebar_hidden")}if(save){$.ajax({url:widget.data.urls.sidebar_toggle,type:"POST",data:{visible:visible?0:1,submitted:"submitted"}})}};App.Wireframe.PageTitle.addAction("show_sidebar",{text:App.lang("Show Sidebar"),url:"#",icon:App.Wireframe.Utils.widgetImageUrl("show-sidebar.png","calendar","calendars"),onclick:function(dom_event){toggle_sidebar(1,true);return false}},"calendar_show_sidebar");_this.sidebar.find(".sidebar_title .hide_sidebar").click(function(){toggle_sidebar(0,true);return false});toggle_sidebar(widget.data.settings.sidebar_hidden?0:1,false)}};var Navigation=function(widget){var _this=this;this.init=function(){var modes=$('<div class="calendar_view_modes"></div>').appendTo(widget.wireframe.top);var buttons=$('<div class="calendar_navigation_buttons"></div>').appendTo(widget.wireframe.top);_this.title=$('<h1 class="calendar_title"></h1>').appendTo(widget.wireframe.top).text(App.lang("Calendar"));App.Wireframe.PageTitle.addAction("previous_month",{text:App.lang("Previous"),url:"#",icon:App.Wireframe.Utils.widgetImageUrl("previous-button.png","calendar","calendars"),onclick:function(){widget.grid.page.prev();_this.change();return false}},"calendar_title_navigation_previous");App.Wireframe.PageTitle.addAction("current_month",{text:App.lang("Today"),url:"#",onclick:function(){widget.grid.page.current();_this.change();return false}},"calendar_title_navigation_current");App.Wireframe.PageTitle.addAction("next_month",{text:App.lang("Next"),url:"#",icon:App.Wireframe.Utils.widgetImageUrl("next-button.png","calendar","calendars"),onclick:function(){widget.grid.page.next();_this.change();return false}},"calendar_title_navigation_next");if(widget.data.settings.can_add_event){App.Wireframe.PageTitle.addAction("new_event",{text:App.lang("New Event"),url:"#",icon:App.Wireframe.Utils.imageUrl("icons/16x16/add.png","environment"),onclick:function(dom_event){var parent_id=widget.selected_calendar instanceof Calendar?widget.selected_calendar.id:0;App.Delegates.flyoutFormClick.apply(this,[dom_event,{width:"400",title:App.lang("Add New Event"),href:App.extendUrl(widget.data.urls.events_add,{async:1,date:Date.today().toString("yyyy-MM-dd"),parent_id:parent_id}),success_event:"calendar_event_created"}]);return false}},"calendar_title_navigation_new_event")}};this.change=function(mode){if(typeof mode!="undefined"){widget.data.mode=mode}widget.calendar_events.cancelFetch();widget.calendar_events.unsetAll();App.Wireframe.LoadingIndicator.show();$.when(widget.calendar_events.fetch(widget.data.current_date)).then(function(){App.Wireframe.LoadingIndicator.hide();widget.initMode()})}};var Widget=function(){var _this=this;this.init=function(wrapper,data){_this.wrapper=$(wrapper);_this.handlers.init();_this.data=data;_this.data.settings=$.extend(settings,_this.data.settings);_this.data.today_day=new Date();var _current_date=new Date(Date.parse(_this.data.current_date.mysql));_this.data.current_date=new Date(_current_date.getTime()+(_current_date.getTimezoneOffset()*60000));_this.data.first_week_day=_this.data.settings.first_week_day;_this.data.last_week_day=_this.data.first_week_day-1<0?6:_this.data.first_week_day-1;_this.data.work_days=new Array();$.each(_this.data.settings.work_days,function(index,value){_this.data.work_days.push(parseInt(value))});_this.force_close_bubble="force_close_bubble";_this.selected_calendar=null;_this.selected_calendar_event=null;_this.data.calendar_colors={};_this.dropped_calendar_event=null;_this.wireframe=new Wireframe(_this);_this.nav=new Navigation(_this);_this.groups=new Groups(_this);_this.filter=new Filter(_this);_this.calendars=new Calendars(_this);_this.calendar_events=new CalendarEvents(_this);_this.wireframe.init();_this.nav.init();_this.groups.init();if(_this.data.filter.enabled){_this.filter.init()}_this.calendar_events.init();_this.initMode()};this.initMode=function(mode){if(typeof mode=="undefined"){mode=_this.data.mode}_this.wireframe.bottom.empty();switch(mode){case"weekly":_this.grid=new GridWeekly(_this);_this.grid.init();break;case"monthly":_this.url=new UrlMonthly(_this);_this.url.init();_this.grid=new GridMonthly(_this);_this.grid.init();_this.grid.renderCalendarEvents();_this.grid.focusOnToday();break;case"yearly":_this.grid=new GridYearly(_this);_this.grid.init();break;default:throw new Error("Unknown calendar mode ("+mode+")");break}};this.handlers={init:function(){App.Wireframe.Events.bind("calendar_created.content",function(event,response){var calendar=new Calendar(_this,response);_this.calendars.add(calendar);var user_id=calendar.created_by_id;_this.wireframe.sidebar_content.find("div.calendars_wrapper:first p.empty_page").remove();var user_calendar_wrapper=_this.wireframe.sidebar_content.find('div.calendars_wrapper ul[data-user-id="'+user_id+'"]');if(user_calendar_wrapper.length>0){user_calendar_wrapper.append(calendar.render(true))}else{var title=calendar.created_by_name;var content=calendar.render();var rendered_calendars=_this.groups.wrapCalendars(user_id,title,content,true);_this.wireframe.sidebar_content.find("div.calendars_wrapper:first").prepend(rendered_calendars)}App.Wireframe.Flash.success(App.lang("Calendar has been created"))});App.Wireframe.Events.bind("user_calendar_updated.content",function(event,response){var calendar=new Calendar(_this,response);_this.calendars.add(calendar);var user_id=calendar.created_by_id;_this.wireframe.sidebar_content.find("div.calendars_wrapper:first p.empty_page").remove();var user_calendar_wrapper=_this.wireframe.sidebar_content.find('div.calendars_wrapper ul[data-user-id="'+user_id+'"]');if(user_calendar_wrapper.length>0){user_calendar_wrapper.append(calendar.render(true))}else{var title=calendar.created_by_name;var content=calendar.render();var rendered_calendars=_this.groups.wrapCalendars(user_id,title,content,true);if(calendar.isMy(_this.data.settings.logged_user.id)){_this.wireframe.sidebar_content.find("div.calendars_wrapper:first").prepend(rendered_calendars)}else{_this.wireframe.sidebar_content.find("div.calendars_wrapper:first").append(rendered_calendars)}}App.Wireframe.LoadingIndicator.show();$.when(_this.calendar_events.fetch(_this.data.current_date)).then(function(){App.Wireframe.LoadingIndicator.hide();_this.grid.renderCalendarEvents()})});App.Wireframe.Events.bind("calendar_updated.content",function(event,response){var calendar=new Calendar(_this,response);_this.calendars.update(calendar);var rendered_calendar=calendar.render(true);_this.wireframe.sidebar_content.find('li.calendar[data-type="'+calendar.type+'"][data-id="'+calendar.id+'"]').replaceWith(rendered_calendar);if(_this.selected_calendar instanceof Calendar&&_this.selected_calendar.id==calendar.id&&_this.selected_calendar.type==calendar.type){rendered_calendar.addClass("selected")}_this.grid.changeEventsColor(calendar)});App.Wireframe.Events.bind("calendar_deleted.content user_calendar_deleted.content",function(event,response){var id=response.id;var type=response.type;var calendar=_this.calendars.get(type,id);if(!(calendar instanceof Calendar)){return false}_this.calendars.unset(calendar);var li=_this.wireframe.sidebar_content.find('li[data-id="'+calendar.id+'"][data-type="'+calendar.type+'"]');var parent=li.parent();var parent_wrapper=parent.parent();li.remove();var is_container_empty=parent.children().length>0?false:true;if(is_container_empty){var name_separator=parent.prev();if(name_separator&&name_separator.length){name_separator.remove()}parent.remove()}if(!parent_wrapper.children().length){var empty_list=_this.groups.renderEmptyList(true);empty_list.appendTo(parent_wrapper)}App.widgets.FlyoutDialog.front().close();_this.grid.renderCalendarEvents()});App.Wireframe.Events.bind("calendar_event_created.content",function(event,response){var calendar_event=new CalendarEvent(_this,response);var calendar=_this.calendars.getByCalendarEvent(calendar_event);_this.calendar_events.add(calendar_event);if(calendar instanceof Calendar){calendar.setVisible(_this,true);_this.grid.renderCalendarEvents();App.Wireframe.Flash.success(App.lang("Calendar event has been created"))}});App.Wireframe.Events.bind("calendar_event_updated.content",function(event,response){var calendar_event=new CalendarEvent(_this,response);if(_this.calendar_events.exsist(calendar_event)){_this.calendar_events.update(calendar_event)}else{_this.calendar_events.add(calendar_event)}if(calendar_event.type=="Task"){_this.calendar_events.changeRenderByParent(calendar_event,true)}_this.grid.renderCalendarEvents();App.Wireframe.Flash.success(App.lang("Calendar event has been updated"))});App.Wireframe.Events.bind("calendar_event_deleted milestone_deleted task_deleted subtask_deleted",function(event,response){var calendar_event=new CalendarEvent(_this,response);_this.calendar_events.unset(calendar_event);if(calendar_event.type=="Task"){_this.calendar_events.changeRenderByParent(calendar_event,false)}App.widgets.FlyoutDialog.front().close();_this.grid.renderCalendarEvents()});App.Wireframe.Events.bind("milestone_updated.content task_updated.content subtask_updated.content milestone_created.content task_created.content subtask_created.content",function(event,response){if(typeof(response.due_on)=="undefined"){return}if(typeof(response.start_on)=="undefined"){response.start_on=response.due_on}if(typeof(response.project_id)=="undefined"){var parent_calendar_event=_this.calendar_events.get(response.parent_class,response.parent_id);if(parent_calendar_event instanceof CalendarEvent){response.project_id=parent_calendar_event.parent_id}}var data={id:response.id,type:response.type,parent_id:response.project_id,parent_type:"Project",name:response.name,ends_on:response.due_on,starts_on:response.start_on,permissions:{can_edit:response.permissions["can_edit"],can_trash:response.permissions["can_trash"],can_reschedule:response.permissions["can_reschedule"]},urls:{view:response.urls["view"],edit:response.urls["edit"],reschedule:response.urls["reschedule"]},completed:(typeof(response.completed_on!="undefined")&&response.completed_on)};App.Wireframe.Events.trigger("calendar_event_rescheduled.content",data)});App.Wireframe.Events.bind("calendar_event_rescheduled.content",function(event,response){var data=typeof response!="undefined"?response:null;var affected_milestones=typeof response.affected_milestones!="undefined"?response.affected_milestones:null;var affected_tasks=typeof response.affected_tasks!="undefined"?response.affected_tasks:null;var affected_subtasks=typeof response.affected_subtasks!="undefined"?response.affected_subtasks:null;var data_pool=new Array();if(affected_milestones){data_pool=data_pool.concat(affected_milestones)}if(affected_tasks){data_pool=data_pool.concat(affected_tasks)}if(affected_subtasks){data_pool=data_pool.concat(affected_subtasks)}if(data){data_pool.push(data)}$.each(data_pool,function(index,data){if(!data.starts_on||!data.ends_on){var calendar_event=_this.calendar_events.get(data.type,data.id);_this.calendar_events.unset(calendar_event);return true}var calendar_event=new CalendarEvent(_this,data);if(_this.calendar_events.exsist(calendar_event)){_this.calendar_events.update(calendar_event)}else{_this.calendar_events.add(calendar_event)}});_this.grid.renderCalendarEvents()});App.Wireframe.Events.bind("reschedule_canceled",function(event,response){var calendar_event=_this.dropped_calendar_event;if(calendar_event instanceof CalendarEvent){calendar_event.cancelDragging(_this)}_this.dropped_calendar_event=null;_this.grid.renderCalendarEvents()})}}};var UrlMonthly=function(widget){var _this=this;var _url=null;this.init=function(){_url=_this.prepare(widget.data.urls.data,widget.data.current_date)};this.get=function(){return _url};this.prepare=function(url,date,set_as_new){if(!(date instanceof Date)){throw new InvalidDateObjectError()}url=url.replace("--YEAR--",date.getFullYear());url=url.replace("--MONTH--",(date.getMonth()+1));if(set_as_new){_url=url}return url}};var GridWeekly=function(widget){var _this=this;this.init=function(){};this.page={prev:function(){widget.data.current_date.addWeeks(-1)},current:function(){widget.data.current_date=widget.data.today_day.clone()},next:function(){widget.data.current_date.addWeeks(1)}}};var GridMonthly=function(widget){var _this=this;this.init=function(){if(typeof _this.dom!="undefined"){$(_this.dom).remove()}var page_title=widget.data.settings.month_names[widget.data.current_date.getMonth()]+", "+widget.data.current_date.getFullYear();widget.nav.title.text(page_title);App.Wireframe.PageTitle.set(page_title);_this.first_day=get_first_day_on_monthly_scale.apply(widget,[widget.data.current_date]);_this.last_day=get_last_date_on_monthly_scale.apply(widget,[widget.data.current_date]);var days_between=count_days_between(_this.first_day,_this.last_day)+1;var total_weeks=days_between/7;var loop_date=_this.first_day.clone();var rendered="";rendered+='<div class="monthly_grid">';rendered+='<div class="days_of_week">';rendered+='<div class="days">';var day_index;for(var x=widget.data.first_week_day;x<widget.data.first_week_day+7;x++){day_index=x>6?x-7:x;rendered+='<div class="day">'+widget.data.settings.long_week_days[day_index]+"</div>"}rendered+="</div>";rendered+="</div>";rendered+='<div class="weeks">';for(var i=0;i<total_weeks;i++){rendered+='<div class="week" data-date="'+get_day_id(loop_date)+'">';rendered+='<div class="events spanned"></div>';rendered+='<div class="dates_wrapper">';rendered+='<div class="dates">';for(var d=0;d<7;d++){var object_class_list=new Array("date");if(loop_date.getMonth()==widget.data.current_date.getMonth()&&loop_date.getFullYear()==widget.data.current_date.getFullYear()){object_class_list.push("current_month")}var day_title="";if(loop_date.getMonth()==widget.data.today_day.getMonth()&&loop_date.getFullYear()==widget.data.today_day.getFullYear()&&loop_date.getDate()==widget.data.today_day.getDate()){object_class_list.push("today");day_title+=App.lang("Today")+" "}var first_date_of_month=new Date(loop_date.getFullYear(),loop_date.getMonth(),1);if(loop_date.toString("yyyy-MM-dd")==first_date_of_month.toString("yyyy-MM-dd")){day_title+=widget.data.settings.month_names[loop_date.getMonth()]+" "}var title_text="";$.each(widget.data.settings.days_off,function(index,day_off){var _day_off_date=new Date(Date.parse(day_off.date["mysql"]));var day_off_date=new Date(_day_off_date.getTime()+(_day_off_date.getTimezoneOffset()*60000));if(day_off.repeat_yearly){day_off_date.setYear(loop_date.getFullYear())}if(day_off_date.toString("yyyy-MM-dd")==loop_date.toString("yyyy-MM-dd")){title_text=day_off.name;object_class_list.push("day_off");object_class_list.push("holiday")}});if($.inArray("day_off",object_class_list)<0){if(is_day_off.apply(widget,[loop_date])){object_class_list.push("day_off");title_text=false}else{object_class_list.push("work_day")}}var object_classes=object_class_list.join(" ");if(title_text){rendered+='<div class="'+object_classes+'" data-date="'+get_day_id(loop_date)+'" title="'+title_text+'">'}else{rendered+='<div class="'+object_classes+'" data-date="'+get_day_id(loop_date)+'">'}rendered+='<div class="day">'+day_title+loop_date.getDate()+"</div>";rendered+='<div class="events spanned"></div>';rendered+='<div class="events all_day"></div>';rendered+='<div class="events timed"></div>';rendered+="</div>";loop_date.addDays(1)}rendered+="</div>";rendered+="</div>";rendered+="</div>"}rendered+="</div>";rendered+="</div>";rendered+="</div>";var rendered=$(rendered);_this.dom=rendered.get(0);_this.body=rendered;widget.wireframe.bottom.append($(rendered));rendered.disableSelection();App.Wireframe.Events.bind("window_resize.content",function(){var container_height=widget.wireframe.bottom.height()-1;var week_day_height=widget.wireframe.bottom.find("div.days_of_week:first").outerHeight();var days_in_total_height=container_height-week_day_height;var week_count=widget.wireframe.bottom.find("div.week").length;var sample_day=widget.wireframe.bottom.find("div.week:first div.date:first");var cell_vertical_padding=sample_day.outerHeight()-sample_day.height();var cell_height=(days_in_total_height/week_count)-cell_vertical_padding;widget.wireframe.bottom.find("div.week div.date").css("height",cell_height+"px")});App.Wireframe.Events.trigger("window_resize");_this.attach.drop();var bubble_id="bubble_trigger";_this.body.on("click","div.event",function(e){var target=$(this);_this.unselectCalendarEvents(true);var id=target.attr("data-id");var type=target.attr("data-type");var calendar_event=widget.calendar_events.get(type,id);_this.selectCalendarEvent(calendar_event);var instanced=typeof($.data(target[0],"bubble"))!="undefined"?true:false;if(target.is(".temp")||instanced||!widget.data.settings.can_add_event){return false}if(!(calendar_event instanceof CalendarEvent)||!calendar_event.permissions.can_edit||calendar_event.completed||calendar_event.archived){$("[bubble-id='"+bubble_id+"']").bubble("close");return false}var url=calendar_event.urls.edit;var pointTo=target.find("span.event:first");var title=App.lang("Calendar Event");switch(calendar_event.type){case"Milestone":title='<a href="'+calendar_event.urls.view+'" class="quick_view_item bubble_link">'+App.lang("Milestone")+"</a>";break;case"Task":title='<a href="'+calendar_event.urls.view+'" class="quick_view_item bubble_link">'+App.lang("Task")+"</a>";break;case"ProjectObjectSubtask":title='<a href="'+calendar_event.urls.view+'" class="quick_view_item bubble_link">'+App.lang("Subtask")+"</a>";break;default:break}e.stopPropagation();if(url){target.bubble({url:url,pointTo:pointTo,width:350,onClose:"close_bubble_popup",onSuccess:"calendar_event_updated",preventCloseOn:".ui-datepicker, .ui-datepicker-header, .ui-widget, .flyout_dialog, .event",id:bubble_id,title:title});App.Wireframe.Events.bind("calendar_event_deleted milestone_deleted task_deleted subtask_deleted calendar_event_rescheduled.content",function(){target.bubble("close")})}else{return false}});_this.body.on("click","div.date",function(e){var date=$(this);var all_day_list=date.find("div.events.all_day");var exist=all_day_list.find("div.event.temp");if(exist.length){return true}if(!widget.data.settings.can_add_event){return false}_this.unselectCalendarEvents();var title=App.lang("New Event");var render="";render+='<div class="event temp" popups_position="right">';render+='<span class="event" title="'+title+'">';render+="â€¢&nbsp;";render+='<span class="title">'+title+"</span>";render+="</span>";render+="</div>";var new_event=$(render);all_day_list.append(new_event);var data_date=date.attr("data-date");if(typeof data_date=="undefined"){data_date=date.parents("div.date").first().attr("data-date")}var parent_id=widget.selected_calendar instanceof Calendar?widget.selected_calendar.id:0;var url=App.extendUrl(widget.data.urls.events_add,{date:data_date,parent_id:parent_id});new_event.bubble({url:url,pointTo:date.find("div.event.temp span.event:first"),width:350,onClose:"close_bubble_popup_for_new_event",onSuccess:"calendar_event_created",preventCloseOn:".ui-datepicker, .ui-datepicker-header, .ui-widget, .flyout_dialog, .date",id:bubble_id,title:App.lang("New Calendar Event")})});$(window).bind("resize.calendar_events",function(){check_out_of_bounds.apply(_this.body[0])});_this.body.bind("scroll.calendar_events",function(){check_out_of_bounds.apply(this)});function check_out_of_bounds(){var body=$(this);var new_event=body.find("div.event.temp");if(!new_event.length){return false}var instanced=typeof($.data(new_event[0],"bubble"))!="undefined"?true:false;if(!instanced){return false}var body_offset=body.offset();var new_event_offset=new_event.offset();var half_offset=new_event_offset.top+(new_event.outerHeight()/2);var max_bottom=body_offset.top+body.innerHeight();if(half_offset>=max_bottom){new_event.bubble("hide")}else{new_event.bubble("show")}}App.Wireframe.Events.bind("close_bubble_popup",function(dom_event,object){});App.Wireframe.Events.bind("close_bubble_popup_for_new_event",function(dom_event,object){$(object).remove()})};this.selectCalendarEvent=function(calendar_event){if(typeof(calendar_event)=="undefined"){calendar_event=widget.selected_calendar_event}if(!(calendar_event instanceof CalendarEvent)){return false}var next_calendar=widget.calendars.getByCalendarEvent(calendar_event);if(!(next_calendar instanceof Calendar)){return false}var starts_on=calendar_event.starts_on;var ends_on=calendar_event.ends_on;var calculated_colors=calculate_spanned_event_colors("#"+next_calendar.color,true,true);var next_objects=_this.body.find('div.event[data-id="'+calendar_event.id+'"][data-type="'+calendar_event.type+'"][data-from="'+calendar_event.parent_type+'"][data-from-id="'+calendar_event.parent_id+'"]');$.each(next_objects,function(){var next_object=$(this);if(starts_on<ends_on){next_object.find("span.color").css({"background-color":calculated_colors["border-color"]});next_object.addClass("selected").css("background-color",calculated_colors["background-color"]).css("color",calculated_colors["text-color"]).css("border","1px solid "+calculated_colors["border-color"])}else{next_object.addClass("selected").css("background-color",widget.data.settings.singleday_background_color)}});widget.wireframe.sidebar.find('li.calendar[data-id="'+next_calendar.id+'"][data-type="'+next_calendar.type+'"]').addClass("selected");widget.selected_calendar=next_calendar;widget.selected_calendar_event=calendar_event};this.unselectCalendarEvents=function(and_calendar){var objects=_this.body.find("div.event.selected");if(typeof(and_calendar)!="undefined"&&and_calendar){widget.wireframe.sidebar.find("li.calendar.selected").removeClass("selected");widget.selected_calendar=null}widget.selected_calendar_event=null;$.each(objects,function(){var object=$(this);object.removeClass("selected");var id=object.attr("data-id");var type=object.attr("data-type");var selected_calendar_event=widget.calendar_events.get(type,id);if(selected_calendar_event instanceof CalendarEvent){var prev_calendar=widget.calendars.get(selected_calendar_event.parent_type,selected_calendar_event.parent_id);var starts_on=selected_calendar_event.starts_on;var ends_on=selected_calendar_event.ends_on;var calculated_colors=calculate_spanned_event_colors("#"+prev_calendar.color);var prev_objects=_this.body.find('div.event[data-id="'+selected_calendar_event.id+'"][data-type="'+selected_calendar_event.type+'"][data-from="'+selected_calendar_event.parent_type+'"][data-from-id="'+selected_calendar_event.parent_id+'"]');$.each(prev_objects,function(){var prev_object=$(this);if(starts_on<ends_on){prev_object.find("span.color").css({"background-color":calculated_colors["border-color"]});prev_object.removeClass("selected").css("background-color",calculated_colors["background-color"]).css("color",calculated_colors["text-color"]).css("border","1px solid "+calculated_colors["border-color"])}else{prev_object.removeClass("selected").css("background-color","transparent")}})}})};this.focusOnToday=function(){var today=widget.wireframe.bottom.find("div.date.today");if(today.is("div.date.today")){$(_this.dom).scrollTo(today)}};this.renderCalendarEvents=function(is_dragging){if(typeof is_dragging=="undefined"){is_dragging=false}var calendar_events=widget.calendar_events.get();var multiday_events=new Array();var singleday_events=new Array();$.each(calendar_events,function(index,calendar_event){var calendar=widget.calendars.getByCalendarEvent(calendar_event);if(!(calendar instanceof Calendar)||!calendar.isVisible()||!calendar_event.render){return true}var calendar_events_pool=new Array();var repeat_id=0;if(calendar_event.isRepeating()){var repeat_id=0;var loop_date=calendar_event.temp_starts_on.clone();var last_date=_this.last_day.clone();if(calendar_event.temp_repeat_until&&calendar_event.temp_repeat_until instanceof Date&&calendar_event.temp_repeat_until<=last_date){last_date=calendar_event.temp_repeat_until.clone()}var days_between=count_days_between(calendar_event.temp_starts_on,calendar_event.temp_ends_on);loop_date.setHours(0,0,0,0);last_date.setHours(0,0,0,0);while(loop_date<=last_date){var calendar_event_clone=calendar_event.clone();calendar_event_clone.starts_on=loop_date.clone();calendar_event_clone.ends_on=loop_date.clone().addDays(days_between);calendar_event_clone.temp_starts_on=loop_date.clone();calendar_event_clone.temp_ends_on=loop_date.clone().addDays(days_between);calendar_event_clone.repeat_id=repeat_id;calendar_events_pool.push(calendar_event_clone);repeat_id++;switch(calendar_event.repeat){case"daily":loop_date.addDays(1);break;case"weekly":loop_date.addWeeks(1);break;case"monthly":loop_date.addMonths(1);break;case"yearly":loop_date.addYears(1);break}}}else{calendar_events_pool.push(calendar_event)}$.each(calendar_events_pool,function(index,looped_calendar_event){var starts_on=looped_calendar_event.starts_on;var ends_on=looped_calendar_event.ends_on;if(starts_on<ends_on){multiday_events.push(looped_calendar_event)}else{singleday_events.push(looped_calendar_event)}})});widget.grid.cleanOld();if(singleday_events.length){SingledayRender(singleday_events)}if(multiday_events.length){MultidayRender(multiday_events)}_this.selectCalendarEvent();if(!is_dragging){_this.attach.drag()}};this.cleanOld=function(){_this.body.find("div.weeks div.events").empty()};this.changeEventsColor=function(calendar){MultidayChangeColor(calendar);SingledayChangeColor(calendar)};var MultidayRender=function(calendar_events){var weeks={};var Week=function(){this.data="";this.rows=new Array();this.spacers=new Array(0,0,0,0,0,0,0)};var Row=function(){this.data="";this.used_slots=new Array()};$.each(calendar_events,function(index,calendar_event){var dragging=(typeof calendar_event.dragging!="undefined")?calendar_event.dragging:false;var starts_on=calendar_event.temp_starts_on;var ends_on=calendar_event.temp_ends_on;var calendar=widget.calendars.getByCalendarEvent(calendar_event);var color="#FFFFFF";var background_color="#"+(calendar instanceof Calendar?calendar.color:widget.data.settings.default_calendar_color);var first_scale_day=_this.first_day;var last_scale_day=_this.last_day;var wrap_first=false;if(starts_on<=first_scale_day&&ends_on>=first_scale_day){starts_on=first_scale_day.clone();wrap_first=true}var week_date=get_first_date_in_week.apply(widget,[starts_on]);var slot=starts_on.getDay();if(widget.data.first_week_day>starts_on.getDay()){slot=7-(widget.data.first_week_day-starts_on.getDay())}else{if(starts_on.getDay()>=widget.data.first_week_day){slot=starts_on.getDay()-widget.data.first_week_day}}var days_between_dates=count_days_between(starts_on,ends_on)+1;var parts=0;while(days_between_dates>0){if(last_scale_day<week_date){break}var object_classes=new Array("event");var width=7;if(slot>0){width-=slot}if(width>=days_between_dates){width=days_between_dates}else{object_classes.push("wraps_next")}if(wrap_first||parts>0){object_classes.push("wraps_prev")}if(wrap_first){wrap_first=false}object_classes.push("width_"+width);object_classes.push("slot_"+slot);if(calendar_event.completed){object_classes.push("completed")}if(calendar_event.archived){object_classes.push("archived")}if(!calendar_event.permissions.can_reschedule){object_classes.push("do-not-drag")}var object_style=new Array();var calculated_colors=calculate_spanned_event_colors(background_color);object_style.push("background-color: "+calculated_colors["background-color"]+";");object_style.push("color: "+calculated_colors["text-color"]+";");object_style.push("border: 1px solid "+calculated_colors["border-color"]+";");if(dragging){object_style.push("opacity: 0.4 !important;")}var calendar_event_object='<div class="'+object_classes.join(" ")+'" data-id="'+calendar_event.id+'" data-type="'+calendar_event.type+'" data-from="'+calendar.type+'" data-from-id="'+calendar.id+'" title="'+calendar_event.name+'" style="'+object_style.join(" ")+'"><span class="event"><span class="color" style="background-color: '+calculated_colors["border-color"]+'"  title="'+App.clean(calendar.name)+'"></span><span class="title">'+calendar_event.name+"</span></span></div>";var week_id=get_day_id(week_date);if(!(weeks[week_id] instanceof Week)){weeks[week_id]=new Week()}var row_count=0;var placed=false;$.each(weeks[week_id].rows,function(row_index,row){row_count++;var req_slots=new Array();var req_spacers=new Array();for(var i=0;i<width;i++){var req_slot=slot+i;if($.inArray(req_slot,row.used_slots)>-1){return true}req_slots.push(req_slot);req_spacers[req_slot]=row_count}$.each(req_slots,function(index,value){weeks[week_id].rows[row_index].used_slots.push(value)});$.each(req_spacers,function(index,value){if(weeks[week_id].spacers[index]<value){weeks[week_id].spacers[index]=value}});weeks[week_id].rows[row_index].data+=calendar_event_object;placed=true;return false});if(!placed){row_count++;var new_row=new Row();for(var i=0;i<width;i++){var req_slot=slot+i;weeks[week_id].spacers[req_slot]=row_count;new_row.used_slots.push(req_slot)}new_row.data+=calendar_event_object;weeks[week_id].rows.push(new_row)}days_between_dates-=width;slot=0;parts++;week_date.addDays(7)}});$.each(weeks,function(week_id,week){var render="";$.each(week.rows,function(row_index,row){render+='<div class="row">';render+=row.data;render+="</div>";render+='<div class="spacer"></div>'});var wrapper=_this.body.find('div.week[data-date="'+week_id+'"]');$.each(week.spacers,function(index,value){var place_for_spacers=wrapper.find("div.date:eq("+index+") div.events.spanned");place_for_spacers.empty();var spacers="";for(var i=0;i<value;i++){spacers+='<div class="spacer"></div>'}place_for_spacers.append(spacers)});wrapper.find("div.events.spanned:first").append(render)})};var MultidayChangeColor=function(calendar){if(calendar instanceof Calendar){var calculated_colors=calculate_spanned_event_colors("#"+calendar.color);_this.body.find('div.events.spanned div.row div.event[data-from="'+calendar.type+'"][data-from-id="'+calendar.id+'"]').css({"background-color":calculated_colors["background-color"],color:calculated_colors["text-color"],"border-color":calculated_colors["border-color"]});var calculated_colors=calculate_spanned_event_colors("#"+calendar.color,true,true);_this.body.find('div.events.spanned div.row div.event[data-from="'+calendar.type+'"][data-from-id="'+calendar.id+'"].selected').css({"background-color":calculated_colors["background-color"],color:calculated_colors["text-color"],"border-color":calculated_colors["border-color"]});_this.body.find('div.events.spanned div.row div.event[data-from="'+calendar.type+'"][data-from-id="'+calendar.id+'"] span.color').css({"background-color":calculated_colors["border-color"]})}};var SingledayRender=function(calendar_events){var types={all_day:{},timed:{}};var Day=function(){this.data=""};$.each(calendar_events,function(index,calendar_event){var dragging=(typeof calendar_event.dragging!="undefined")?calendar_event.dragging:false;var starts_on=calendar_event.temp_starts_on;var day_id=get_day_id(starts_on);var calendar=widget.calendars.getByCalendarEvent(calendar_event);var color="#"+(calendar instanceof Calendar?calendar.color:widget.data.settings.default_calendar_color);var object_style=new Array();object_style.push("color: "+color+";");if(dragging){object_style.push("opacity: 0.4 !important;")}var object_classes=new Array("event");if(calendar_event.completed){object_classes.push("completed")}if(calendar_event.archived){object_classes.push("archived")}if(!calendar_event.permissions.can_reschedule){object_classes.push("do-not-drag")}var time="";if(calendar_event.starts_on_time){time='<span class="time">'+calendar_event.starts_on_time+"</span>"}object_style.push("background-color: transparent;");var rendered="";rendered+='<div class="'+object_classes.join(" ")+'" data-id="'+calendar_event.id+'" data-type="'+calendar_event.type+'" data-from="'+calendar.type+'" data-from-id="'+calendar.id+'" repeat-id="'+calendar_event.repeat_id+'" style="'+object_style.join(" ")+';">';rendered+='<span title="'+calendar_event.name+'" class="event">â€¢&nbsp;<span class="title">'+calendar_event.name+"</span>"+time+"</span>";rendered+="</div>";if(calendar_event.starts_on_time){if(!(types.timed[day_id] instanceof Day)){types.timed[day_id]=new Day()}types.timed[day_id].data+=rendered}else{if(!(types.all_day[day_id] instanceof Day)){types.all_day[day_id]=new Day()}types.all_day[day_id].data+=rendered}});$.each(types,function(type,days){$.each(days,function(day_id,day){_this.body.find('div.date[data-date="'+day_id+'"] div.events.'+type).append(day.data)})})};var SingledayChangeColor=function(calendar){if(calendar instanceof Calendar){_this.body.find('div.date div.event[data-from="'+calendar.type+'"][data-from-id="'+calendar.id+'"]').css("color","#"+calendar.color)}};this.page={prev:function(){widget.data.current_date.addMonths(-1)},current:function(){widget.data.current_date=widget.data.today_day.clone()},next:function(){widget.data.current_date.addMonths(1)}};this.attach={drop:function(){_this.body.find("div.date").droppable({tolerance:"pointer",over:function(event,ui){droppable_handler.apply(this,[event,ui,widget,false])},drop:function(event,ui){droppable_handler.apply(this,[event,ui,widget,true])}})},drag:function(){_this.body.find("div.weeks div.event").draggable({scroll:true,cancel:".do-not-drag",start:function(event,ui){var dragged=$(this);var week=dragged.parents("div.week:first");var weeks=week.parent();var width=weeks.width();var offset=weeks.offset();var relX=event.pageX-offset.left;var relY=event.pageY-offset.top;var position=0;var date_width=width/7;for(var i=0;i<=6;i++){var distance=date_width*(i+1);if(relX<=distance){position=i;break}}var date=$(week.find("div.date").get(position));dragged.addClass("ghost").removeClass("wraps_next").removeClass("wraps_prev").css("width","200px","important").css("display","none").appendTo(_this.body);dragged.data("offset",date.attr("data-date"))},revert:function(dropped){var dragged=$(this);if(!dropped){var calendar_event=widget.calendar_events.get(dragged.attr("data-type"),dragged.attr("data-id"));calendar_event.cancelDragging(widget);_this.renderCalendarEvents()}return dropped}})}}};var GridYearly=function(widget){var _this=this;this.init=function(){};this.page={prev:function(){widget.data.current_date.addYears(-1);_this.init()},current:function(){widget.data.current_date=widget.data.today_day.clone();_this.init()},next:function(){widget.data.current_date.addYears(1);_this.init()}}};var droppable_handler=function(event,ui,widget,is_drop){var dragged_object=ui.draggable;var dropped_on=$(this);var id=dragged_object.attr("data-id");var type=dragged_object.attr("data-type");var _offset_date=new Date(Date.parse(dragged_object.data("offset")));var offset_date=new Date(_offset_date.getTime()+(_offset_date.getTimezoneOffset()*60000));var calendar_event=widget.calendar_events.get(type,id);if(is_drop){dragged_object.remove()}if(calendar_event instanceof CalendarEvent){var _dropped_on_date=new Date(Date.parse(dropped_on.attr("data-date")));var dropped_on_date=new Date(_dropped_on_date.getTime()+(_dropped_on_date.getTimezoneOffset()*60000));var days_offset=0;if(dropped_on_date<offset_date){days_offset=count_days_between(dropped_on_date,offset_date)*(-1)}else{if(offset_date<dropped_on_date){days_offset=count_days_between(offset_date,dropped_on_date)}}var new_start_date=calendar_event.starts_on.clone();new_start_date.addDays(days_offset);var days_between=count_days_between(calendar_event.starts_on,calendar_event.ends_on);calendar_event.temp_starts_on=new_start_date;calendar_event.temp_ends_on=calendar_event.temp_starts_on.clone().addDays(days_between);calendar_event.dragging=!is_drop;if(calendar_event.isRepeating()&&calendar_event.repeat_until instanceof Date){calendar_event.temp_repeat_until=calendar_event.repeat_until.clone();calendar_event.temp_repeat_until.addDays(days_offset)}if(is_drop){if(calendar_event.starts_on.toString("Y-m-d")!=calendar_event.temp_starts_on.toString("Y-m-d")||calendar_event.ends_on.toString("Y-m-d")!=calendar_event.temp_ends_on.toString("Y-m-d")){var type=calendar_event.type;if(type=="Milestone"||type=="Task"||type=="ProjectObjectSubtask"){widget.dropped_calendar_event=calendar_event.clone();var data_to_send={async:1,describe_affected:1,as_calendar_events:1};data_to_send=$.extend(data_to_send,calendar_event.prepare({start_on:"temp_starts_on",due_on:"temp_ends_on"}));App.Delegates.flyoutFormClick.apply(this,[event,{width:"narrow",title:App.lang("Reschedule"),href:App.extendUrl(calendar_event.urls.reschedule,data_to_send),success_event:"calendar_event_rescheduled",on_close_event:"reschedule_canceled"}])}else{if(calendar_event.temp_starts_on instanceof Date){calendar_event.starts_on=calendar_event.temp_starts_on.clone()}if(calendar_event.temp_ends_on instanceof Date){calendar_event.ends_on=calendar_event.temp_ends_on.clone()}if(calendar_event.temp_repeat_until instanceof Date){calendar_event.repeat_until=calendar_event.temp_repeat_until.clone()}widget.calendar_events.update(calendar_event,true)}}}else{widget.calendar_events.update(calendar_event)}widget.grid.renderCalendarEvents(!is_drop)}};var get_first_day_on_monthly_scale=function(date){var first_scale_day=date.clone().moveToFirstDayOfMonth();first_scale_day.setHours(0,0,0,0);if(this.data.first_week_day>first_scale_day.getDay()){return first_scale_day.addDays(-7+(this.data.first_week_day-first_scale_day.getDay()))}else{if(this.data.first_week_day<first_scale_day.getDay()){return first_scale_day.addDays(-1*(first_scale_day.getDay()-this.data.first_week_day))}}return first_scale_day};var get_last_date_on_monthly_scale=function(date){var last_scale_day=date.clone().moveToLastDayOfMonth();last_scale_day.setHours(0,0,0,0);if(last_scale_day.getDay()>this.data.last_week_day){return last_scale_day.addDays(this.data.last_week_day-last_scale_day.getDay()+7)}else{if(last_scale_day.getDay()<this.data.last_week_day){return last_scale_day.addDays(this.data.last_week_day-last_scale_day.getDay())}}return last_scale_day};var get_last_date_in_week=function(date){var last_date_in_week=date.clone();if(last_date_in_week.getDay()>this.data.last_week_day){return last_date_in_week.addDays(this.data.last_week_day-last_date_in_week.getDay()+7)}else{if(last_date_in_week.getDay()<this.data.last_week_day){return last_date_in_week.addDays(this.data.last_week_day-last_date_in_week.getDay())}}return last_date_in_week};var count_days_between=function(date1,date2){return Math.round(Math.abs((date1-date2)/(1000*60*60*24)))};var get_first_date_in_week=function(date){return get_last_date_in_week.apply(this,[date]).addDays(-6)};var get_day_id=function(date){return date.toString("yyyy-MM-dd")};var is_day_off=function(date){return $.inArray(date.getDay(),this.data.work_days)==-1};var plugin_name="Calendar";var settings={week_days:{0:App.lang("Sunday"),1:App.lang("Monday"),2:App.lang("Tuesday"),3:App.lang("Wednesday"),4:App.lang("Thursday"),5:App.lang("Friday"),6:App.lang("Saturday")},short_week_days:{0:App.lang("Sun"),1:App.lang("Mon"),2:App.lang("Tue"),3:App.lang("Wed"),4:App.lang("Thu"),5:App.lang("Fri"),6:App.lang("Sat")},long_week_days:{0:App.lang("Sunday"),1:App.lang("Monday"),2:App.lang("Tuesday"),3:App.lang("Wednesday"),4:App.lang("Thursday"),5:App.lang("Friday"),6:App.lang("Saturday")},month_names:{0:App.lang("January"),1:App.lang("February"),2:App.lang("March"),3:App.lang("April"),4:App.lang("May"),5:App.lang("June"),6:App.lang("July"),7:App.lang("August"),8:App.lang("September"),9:App.lang("October"),10:App.lang("November"),11:App.lang("December")},work_days:[1,2,3,4,5],days_off:[],default_calendar_color:"464646",singleday_background_color:"#E7E7E7"};$.fn[plugin_name]=function(method){if(public_methods[method]){return public_methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof method==="object"||!method){return public_methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist in jQuery."+plugin_name)}}}})(jQuery);